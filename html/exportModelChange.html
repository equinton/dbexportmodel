<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>DBExportModel</title>

    <script type="text/javascript" src="jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="../node_modules/jquery-ui-dist/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="../node_modules/jquery-ui-dist/jquery-ui.min.css">
    <script type="text/javascript" src="bootstrap/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../node_modules/handlebars/dist/handlebars.min.js"></script>
    <script type="text/javascript" src="../node_modules/alpaca/dist/alpaca/bootstrap/alpaca.min.js"></script>
    <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="../node_modules/alpaca/dist/alpaca/bootstrap/alpaca.min.css">
    <link rel="stylesheet" href="dbexportmodel.css">
</head>

<body>
    <script type="text/javascript" src="modelPattern.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            var pattern = $("#pattern").val();
            try {
                if (pattern.length > 0) {
                    pattern = pattern.replace(/&quot;/g, '"');
                    pattern = JSON.parse(pattern);
                } else {
                    pattern = "";
                 }
            } catch (e) {
                pattern = "";
            }

            patternForm("alpacaPattern", "pattern", pattern);
            $('#modelForm').submit(function (event) {
                var alp = $("#alpacaPattern").alpaca("get");
                alp.refreshValidationState(true);
                if (!alp.isValid(true)) {
                    alert("The definition of the model is not valid.");
                } else {
                    var data = alp.getValue();
                    saveText(JSON.stringify(data), $("#export_model_name").val());
                }
                event.preventDefault();
            });
            function saveText(text, filename) {
                var a = document.createElement('a');
                a.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                a.setAttribute('download', filename);
                a.click();
            }
            var fileread = new FileReader();
            fileread.onload = function (e) {
                var content = e.target.result;
                try {
                    content = content.replace(/&quot;/g,'"');
                    var data = JSON.parse(content);
                    $("#alpacaPattern").alpaca("destroy");
                    patternForm("alpacaPattern", "pattern",data);
                    //alp.setValue(data);
                    //console.log(data);
                } catch {
                    alert("Data can't be loaded");
                }
            };

            $("#input").change(function () {
                var file = this.files[0];
                if (file) {
                    //console.log(file);
                    $("#export_model_name").val(file.webkitRelativePath + file.name);
                    fileread.readAsText(file);
                }
            });
        });
    </script>
    <h2>Création - Modification d'un modèle d'export de données</h2>
    <form class="form-horizontal protoform" id="modelForm">
        <div class="row">
            <div class="col-md-6">
                <input type="file" id="input" accept="application/json">
                <div class="form-group center">
                    <button type="submit" class="btn btn-primary button-valid">Enregistrer</button>
                </div>
                <div class="form-group">
                    <label for="export_model_name" class="control-label col-md-4"><span class="red">*</span> Nom du
                        modèle :</label>
                    <div class="col-md-8">
                        <input id="export_model_name" type="text" class="form-control" name="export_model_name" value="dbexportdescription.json"
                            required autofocus>
                    </div>
                </div>
            </div>
            <div class="col-md-6"></div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <div id="alpacaPattern"></div>
                <div class="form-group center">
                    <button type="submit" class="btn btn-primary button-valid">Enregistrer</button>
                </div>
            </div>
        </div>
    </form>
    <div class="col-md-12">
        <div class="bg-info">
            <h3>Description of the fields to be filled</h3>
            <ul>
                <li> The table name must match the name in the database</li>
                <li> The alias will be used to rename the table in the export file, if it can be linked to two other tables.</li>
                <li>Each alias must be described</li>
            </ul>
            <h3>How import works</h3>
            <ul>
                <li>The model is read from top to bottom. </li>
                <li>If the business key is filled in, the program will search for a pre-existing record in the table that corresponds to the indicated value. If it exists, this record will be updated, otherwise, a new record will be created</li>
                <li>To keep the primary key present in the export file, for example for the parameter tables, the name of the business key must be identical to the primary key</li>
            </ul>
        </div>
    </div>
</body>

</html>
